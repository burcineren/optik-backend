// Prisma Schema - Optik Mağaza Yönetim Sistemi

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ============================================
// KULLANICI YÖNETİMİ
// ============================================

enum Role {
  ADMIN
  USER
  GUEST
}

model User {
  id           String    @id @default(uuid())
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  isActive     Boolean   @default(true) @map("is_active")
  email        String    @unique
  password     String
  name         String
  role         Role      @default(USER)
  lastLogin    DateTime? @map("last_login")
  refreshToken String?   @map("refresh_token")
  
  profile        UserProfile?
  orders         Order[]
  addresses      Address[]
  stockMovements StockMovement[]
  
  @@map("users")
}

model UserProfile {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  isActive    Boolean   @default(true) @map("is_active")
  bio         String?
  avatarUrl   String?   @map("avatar_url")
  phone       String?
  dateOfBirth DateTime? @map("date_of_birth")
  
  userId      String    @unique @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_profiles")
}

// ============================================
// MÜŞTERİ YÖNETİMİ
// ============================================

model Customer {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  isActive         Boolean   @default(true) @map("is_active")
  tcIdentityNumber String    @unique @db.VarChar(11) @map("tc_identity_number")
  fullName         String    @map("full_name")
  phoneNumber      String?   @map("phone_number")
  email            String?
  address          String?
  
  orders           Order[]
  relative         Relative?
  
  @@map("customers")
}

model Relative {
  id               String   @id @default(uuid())
  fullName         String   @map("full_name")
  tcIdentityNumber String   @db.VarChar(11) @map("tc_identity_number")
  
  customerId       String   @unique @map("customer_id")
  customer         Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@map("relatives")
}

model Address {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  isActive   Boolean  @default(true) @map("is_active")
  title      String
  receiver   String
  phone      String
  city       String
  district   String
  address    String
  isDefault  Boolean  @default(false) @map("is_default")
  
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders     Order[]
  
  @@map("addresses")
}

// ============================================
// ÜRÜN YÖNETİMİ
// ============================================

model Category {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  isActive    Boolean   @default(true) @map("is_active")
  name        String    @unique
  description String?
  imageUrl    String?   @map("image_url")
  slug        String    @unique
  
  products    Product[]
  
  @@map("categories")
}

model Product {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  isActive    Boolean   @default(true) @map("is_active")
  name        String
  description String
  price       Float     @default(0)
  stock       Int       @default(0)
  sku         String?   @unique
  images      String[]
  isFeatured  Boolean   @default(false) @map("is_featured")
  
  categoryId  String    @map("category_id")
  category    Category  @relation(fields: [categoryId], references: [id])
  variants    ProductVariant[]
  orderItems  OrderItem[]
  
  @@map("products")
}

// ============================================
// STOK YÖNETİMİ
// ============================================

enum StockMovementType {
  PURCHASE
  SALE
  RETURN
  ADJUSTMENT
  TRANSFER
  LOSS
  DAMAGED
  OTHER
}

enum StockMovementStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model ProductVariant {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  isActive    Boolean   @default(true) @map("is_active")
  sku         String    @unique
  barcode     String?   @unique
  name        String
  description String?
  price       Float     @default(0)
  costPrice   Float?    @map("cost_price")
  stock       Int       @default(0)
  minStock    Int       @default(5) @map("min_stock")
  maxStock    Int?      @map("max_stock")
  weight      Float?    @default(0)
  dimensions  String?
  
  productId      String @map("product_id")
  product        Product @relation(fields: [productId], references: [id])
  stockMovements StockMovement[]
  
  @@map("product_variants")
}

model StockMovement {
  id           String              @id @default(uuid())
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  movementType StockMovementType   @map("movement_type")
  status       StockMovementStatus @default(PENDING)
  quantity     Int
  unitPrice    Float               @map("unit_price")
  totalPrice   Float               @map("total_price")
  referenceNo  String?             @map("reference_no")
  notes        String?
  movementDate DateTime            @default(now()) @map("movement_date")
  
  variantId String         @map("variant_id")
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  
  userId  String? @map("user_id")
  user    User?   @relation(fields: [userId], references: [id])
  
  orderId String? @map("order_id")
  order   Order?  @relation(fields: [orderId], references: [id])
  
  @@map("stock_movements")
}

// ============================================
// SİPARİŞ YÖNETİMİ
// ============================================

enum OrderStatus {
  PENDING      // Beklemede
  PROCESSING   // İşleniyor
  READY        // Hazır
  DELIVERED    // Teslim Edildi
  CANCELLED    // İptal
  REFUNDED     // İade
}

enum PrescriptionType {
  MANUAL      // Manuel Reçete
  E_RECIPE    // E-Reçete
}

model Order {
  id             String           @id @default(uuid())
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  isActive       Boolean          @default(true) @map("is_active")
  orderNumber    String           @unique @map("order_number")
  
  // Sipariş Tarihleri
  orderDate      DateTime         @default(now()) @map("order_date")
  deliveryDate   DateTime?        @map("delivery_date")
  
  // Ödeme Bilgileri
  totalAmount    Float            @map("total_amount")
  sgkAmount      Float            @default(0) @map("sgk_amount")
  remainingAmount Float           @default(0) @map("remaining_amount")
  
  status         OrderStatus      @default(PENDING)
  prescriptionType PrescriptionType? @map("prescription_type")
  notes          String?
  
  // İlişkiler
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id])
  
  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])
  
  addressId String?  @map("address_id")
  address   Address? @relation(fields: [addressId], references: [id])
  
  items           OrderItem[]
  prescriptions   Prescription[]
  frames          Frame[]
  stockMovements  StockMovement[]
  
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  isActive  Boolean  @default(true) @map("is_active")
  quantity  Int
  price     Float
  
  orderId   String  @map("order_id")
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])
  
  @@unique([orderId, productId])
  @@map("order_items")
}

// ============================================
// REÇETE VE GÖZLÜK BİLGİLERİ
// ============================================

enum EyeSide {
  RIGHT  // Sağ
  LEFT   // Sol
}

model Prescription {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Göz Tarafı
  eyeSide   EyeSide  @map("eye_side")
  
  // Uzak Görüş
  distanceSign String? @default("+") @map("distance_sign") // + veya -
  distanceSph  Float?  @map("distance_sph")
  distanceCyl  Float?  @map("distance_cyl")
  distanceAx   Int?    @map("distance_ax")
  
  // Yakın Görüş
  nearSign String? @default("+") @map("near_sign") // + veya -
  nearSph  Float?  @map("near_sph")
  nearCyl  Float?  @map("near_cyl")
  nearAx   Int?    @map("near_ax")
  
  // Addisyon (Otomatik hesaplanır ama kaydedilir)
  addition Float?  @map("addition")
  
  // Diğer Ölçümler
  pd       Float?  @map("pd")        // Pupil Distance
  height   Float?  @map("height")    // Yükseklik
  diameter Float?  @map("diameter")  // Çap
  
  orderId  String  @map("order_id")
  order    Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  lenses   Lens[]
  
  @@map("prescriptions")
}

model Lens {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Lens Özellikleri
  lensType     String?  @map("lens_type")      // single, bifocal, progressive, office
  material     String?  @map("material")        // cr39, polycarbonate, high-index, trivex
  coating      String?  @map("coating")         // none, anti-reflective, blue-light, photochromic, polarized
  lensIndex    String?  @map("lens_index")      // 1.5, 1.56, 1.6, 1.67, 1.74
  
  prescriptionId String       @map("prescription_id")
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  
  @@map("lenses")
}

model Frame {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Çerçeve Bilgileri
  brand String? // Marka
  model String? // Model
  color String? // Renk
  type  String? // Cinsi (Kemik, Metal, vb.)
  
  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("frames")
}

// ============================================
// İNDEXLER
// ============================================

// Performans için önemli indeksler otomatik oluşturulur:
// - @unique alanlar
// - Foreign key'ler
// - Sık sorgulanan alanlar için ek indeksler eklenebilir